document.addEventListener("DOMContentLoaded",()=>{class ReactablesComponent{el;id;name;checksum;data;baseUrl;route;files={};constructor(el){this.el=el;let data=JSON.parse(this.el.getAttribute("r-data"));this.id=this.el.getAttribute("r-id"),this.name=data.name,this.data=JSON.parse(data.data),this.checksum=data.checksum,this.baseUrl=data.base_url,this.route=data.route,this.removeAttrs(),this.bind(),this.toggleLoads(),this.runInits()}find(query){return Array.from(this.el.querySelectorAll(query)).filter(el=>!el.closest("[r-id]"))}toggleLoads(ready=!0){ready?(this.find("[r-loading]").forEach(el=>{el.style.display="none"}),this.find("[r-ready]").forEach(el=>{let attr=el.getAttribute("r-ready");el.style.display=attr.length?attr:"inline-block"}),this.find("[r-loading-class]").forEach(el=>{el.classList.remove(el.getAttribute("r-loading-class"))}),this.find("[r-ready-class]").forEach(el=>{el.classList.add(el.getAttribute("r-ready-class"))}),this.find("[r-loading-attr]").forEach(el=>{el.removeAttribute(el.getAttribute("r-loading-attr"))}),this.find("[r-ready-attr]").forEach(el=>{el.setAttribute(el.getAttribute("r-loading-attr"),"true")})):(this.find("[r-loading]").forEach(el=>{let attr=el.getAttribute("r-loading");el.style.display=attr.length?attr:"inline-block"}),this.find("[r-ready]").forEach(el=>{el.style.display="none"}),this.find("[r-loading-class]").forEach(el=>{el.classList.add(el.getAttribute("r-loading-class"))}),this.find("[r-ready-class]").forEach(el=>{el.classList.remove(el.getAttribute("r-ready-class"))}),this.find("[r-loading-attr]").forEach(el=>{el.setAttribute(el.getAttribute("r-loading-attr"),"true")}),this.find("[r-ready-attr]").forEach(el=>{el.removeAttribute(el.getAttribute("r-loading-attr"))}))}removeAttrs(){this.el.removeAttribute("r-id"),this.el.removeAttribute("r-data")}bind(){this.bindModels(),this.bindEvents(),this.bindRepeats()}bindModels(){this.find("input[type=text][r-model], input[type=date][r-model], input[type=datetime-local][r-model], input[type=email][r-model], input[type=number][r-model], input[type=month][r-model], input[type=password][r-model], input[type=range][r-model], input[type=search][r-model], input[type=tel][r-model], input[type=time][r-model], input[type=url][r-model], input[type=color][r-model], input[type=week][r-model], textarea[r-model]").forEach(model=>{let name=model.getAttribute("r-model"),lazy=model.hasAttribute("r-lazy"),debounce=model.getAttribute("r-debounce")||250,value=this.getValueDotNotation(this.data,name);void 0!==value&&(model.value=value),model.removeEventListener("input",model.callback),model.callback=()=>{this.setValueDotNotation(this.data,name,model.value),lazy||(debounce?(model.debounceTimeout&&clearTimeout(model.debounceTimeout),model.debounceTimeout=setTimeout(()=>{window.reactables.refresh(this,model)},debounce)):window.reactables.refresh(this,model))},model.addEventListener("input",model.callback),model.removeAttribute("r-model"),model.removeAttribute("r-lazy"),model.removeAttribute("r-debounce")}),this.find("input[type=checkbox][r-model], input[type=radio][r-model]").forEach(model=>{let name=model.getAttribute("r-model"),lazy=model.hasAttribute("r-lazy"),debounce=model.getAttribute("r-debounce"),rawName=name.replace("[]",""),custom=model.getAttribute("value"),value=this.getValueDotNotation(this.data,rawName);name.endsWith("[]")?Array.isArray(value)&&custom&&value.some(v=>v==custom)&&(model.checked=!0):void 0!==value&&(custom?value==custom&&(model.checked=!0):model.checked=value),model.removeEventListener("input",model.callback),model.callback=()=>{if(name.endsWith("[]")){let value=this.getValueDotNotation(this.data,rawName);if(Array.isArray(value)||this.setValueDotNotation(this.data,rawName,[]),custom)if(model.checked)this.setValueDotNotation(this.data,rawName,value.push(custom));else{let idx=value.findIndex(v=>v==custom);-1!==idx&&this.setValueDotNotation(this.data,rawName,value.splice(idx,1))}}else custom?this.setValueDotNotation(this.data,name,!!model.checked&&custom):this.setValueDotNotation(this.data,name,model.checked);lazy||(debounce?(model.debounceTimeout&&clearTimeout(model.debounceTimeout),model.debounceTimeout=setTimeout(()=>{window.reactables.refresh(this,model)},debounce)):window.reactables.refresh(this,model))},model.addEventListener("input",model.callback),model.removeAttribute("r-model"),model.removeAttribute("r-lazy"),model.removeAttribute("r-debounce")}),this.find("select[r-model]").forEach(model=>{let name=model.getAttribute("r-model"),lazy=model.hasAttribute("r-lazy"),debounce=model.getAttribute("r-debounce"),rawName=name.replace("[]",""),value=this.getValueDotNotation(this.data,rawName);name.endsWith("[]")?Array.isArray(value)&&Array.from(model.options).forEach(option=>{value.some(v=>v==option.value)&&(option.selected=!0)}):void 0!==value&&(model.value=value),model.removeEventListener("input",model.callback),model.callback=()=>{if(name.endsWith("[]")){let newValue=[];Array.from(model.selectedOptions).forEach(option=>{newValue.push(option.value)}),this.setValueDotNotation(this.data,rawName,newValue)}else this.setValueDotNotation(this.data,rawName,model.value);lazy||(debounce?(model.debounceTimeout&&clearTimeout(model.debounceTimeout),model.debounceTimeout=setTimeout(()=>{window.reactables.refresh(this,model)},debounce)):window.reactables.refresh(this,model))},model.addEventListener("input",model.callback),model.removeAttribute("r-model"),model.removeAttribute("r-lazy"),model.removeAttribute("r-debounce")}),this.find("input[type=file][r-model]").forEach(model=>{let name=model.getAttribute("r-model"),lazy=model.hasAttribute("r-lazy"),debounce=model.getAttribute("r-debounce");model.removeEventListener("input",model.callback),model.callback=()=>{this.files[name]=model.files,lazy||(debounce?(model.debounceTimeout&&clearTimeout(model.debounceTimeout),model.debounceTimeout=setTimeout(()=>{window.reactables.refresh(this,model)},debounce)):window.reactables.refresh(this,model))},model.addEventListener("input",model.callback),model.removeAttribute("r-model"),model.removeAttribute("r-lazy"),model.removeAttribute("r-debounce")})}getValueDotNotation(object,path){return path.split(".").reduce((a,b)=>a[b],object)}setValueDotNotation(object,path,value){if(Array.isArray(path)||(path=path.split(".")),1!==path.length)return object[path[0]]?this.setValueDotNotation(object[path[0]],path.slice(1),value):(object[path[0]]={},this.setValueDotNotation(object[path[0]],path.slice(1),value));object[path[0]]=value}bindEvents(){this.find("[r-submit]").forEach(el=>{this.defaultEventBinder(el,"submit","r-submit")}),this.find("[r-change]").forEach(el=>{this.defaultEventBinder(el,"change","r-change")}),this.find("[r-focus]").forEach(el=>{this.defaultEventBinder(el,"focus","r-focus")}),this.find("[r-blur]").forEach(el=>{this.defaultEventBinder(el,"blur","r-blur")}),this.find("[r-click]").forEach(el=>{this.defaultEventBinder(el,"click","r-click")}),this.find("[r-hover]").forEach(el=>{this.defaultEventBinder(el,"mouseover","r-hover")}),this.find("[r-move]").forEach(el=>{this.defaultEventBinder(el,"mousemove","r-move")}),this.find("[r-leave]").forEach(el=>{this.defaultEventBinder(el,"mouseleave","r-leave")}),this.find("[r-enter]").forEach(el=>{this.defaultEventBinder(el,"keydown","r-enter","Enter")}),this.find("[r-tab]").forEach(el=>{this.defaultEventBinder(el,"keydown","r-tab","Tab")}),this.find("[r-esc]").forEach(el=>{this.defaultEventBinder(el,"keydown","r-esc","Escape")})}defaultEventBinder(el,event,attr,key=!1){let value=el.getAttribute(attr),follow=el.hasAttribute("r-follow"),debounce=el.getAttribute("r-debounce");el.removeEventListener(event,el.callback),el.callback=event=>{key&&event.key!==key||(follow||event.preventDefault(),debounce?(el.debounceTimeout&&clearTimeout(el.debounceTimeout),el.debounceTimeout=setTimeout(()=>{window.reactables.refresh(this,el,value)},debounce)):window.reactables.refresh(this,el,value))},el.addEventListener(event,el.callback),el.removeAttribute(attr),el.removeAttribute("r-follow"),el.removeAttribute("r-debounce")}bindRepeats(){this.find("[r-repeat][r-interval]").forEach(el=>{let value=el.getAttribute("r-repeat"),interval=el.getAttribute("r-interval"),timeout=el.getAttribute("r-timeout");timeout?(el.timeoutInterval&&clearTimeout(el.timeoutInterval),el.timeoutInterval=setTimeout(()=>{el.repeatInterval&&clearInterval(el.repeatInterval),el.repeatInterval=setInterval(()=>{window.reactables.refresh(this,el,value)},interval)},timeout)):(el.repeatInterval&&clearInterval(el.repeatInterval),el.repeatInterval=setInterval(()=>{window.reactables.refresh(this,el,value)},interval)),el.removeAttribute("r-repeat"),el.removeAttribute("r-interval"),el.removeAttribute("r-timeout")})}runInits(){this.find("[r-init]").forEach(el=>{let value=el.getAttribute("r-init"),timeout=el.getAttribute("r-timeout"),timeoutInterval=null;timeout?(timeoutInterval&&clearTimeout(timeoutInterval),timeoutInterval=setTimeout(()=>{window.reactables.refresh(this,el,value)},timeout)):window.reactables.refresh(this,el,value),el.removeAttribute("r-init"),el.removeAttribute("r-timeout")})}removeInits(){this.find("[r-init]").forEach(el=>{el.removeAttribute("r-init"),el.removeAttribute("r-timeout")})}parseQuery(query){let url=location.pathname;query&&query.length&&(url+="?"+query),location.hash&&(url+=location.hash),url!=location.href&&history.pushState({},"",url)}dispatchEvents(events){events&&events.length&&events.forEach(event=>{window.reactables.listeners[event.name]&&window.reactables.listeners[event.name](...event.params)})}}class Reactables{components=[];listeners={};errorHandler;expiredHandler;overflow;init(){document.querySelectorAll("[r-id]").forEach(el=>{this.components.push(new ReactablesComponent(el))});let ready=new Event("reactables-ready");document.dispatchEvent(ready)}all(){return this.components}find(id){return this.components.find(c=>c.id==id)}on(eventName,callback){this.listeners[eventName]=callback}onError(callback){this.errorHandler=callback}onPageExpired(callback){this.expiredHandler=callback}showError(error){let html=document.createElement("html");html.innerHTML=error;let modal=document.createElement("div");modal.style.cssText="position:fixed;inset:0;padding:30px;z-index:999999;background:rgba(0,0,0,.7);";let iframe=document.createElement("iframe");iframe.style.cssText="width:100%;height:100%;border-radius:5px;",modal.appendChild(iframe),document.body.prepend(modal),this.overflow=document.body.style.overflow,document.body.style.overflow="hidden",iframe.contentWindow.document.open(),iframe.contentWindow.document.write(html.outerHTML),iframe.contentWindow.document.close(),modal.addEventListener("click",()=>{modal.remove(),document.body.style.overflow=this.overflow}),modal.setAttribute("tabindex",0),modal.addEventListener("keydown",e=>{"Escape"===e.key&&(modal.remove(),document.body.style.overflow=this.overflow)}),modal.focus()}showExpired(){confirm("This page has expired.\nWould you like to refresh the page?")&&location.reload()}refreshAll(){this.components.forEach(component=>{this.refresh(component)})}refresh(component,el=null,method=null){component.toggleLoads(!1);let data=new FormData;data.append("id",component.id),data.append("name",component.name),data.append("data",JSON.stringify(component.data)),data.append("checksum",component.checksum),data.append("route",component.route),method&&data.append("method",method);for(let key in component.files)Array.from(component.files[key]).forEach(file=>{data.append(key+"[]",file)});let xhr=new XMLHttpRequest;xhr.responseType="text",xhr.withCredentials=!0,xhr.open("POST",component.baseUrl+"reactables/component",!0),xhr.setRequestHeader("X-Reactables",!0),xhr.upload.onloadstart=()=>{let event=new Event("reactables-upload-start");el&&el.dispatchEvent(event)},xhr.upload.onprogress=e=>{let percent=Math.round(e.loaded/e.total*100),event=new CustomEvent("reactables-upload-progress",{detail:percent});el&&el.dispatchEvent(event)},xhr.upload.onload=()=>{let event=new Event("reactables-upload-success");el&&el.dispatchEvent(event)},xhr.upload.onerror=()=>{let event=new Event("reactables-upload-failed");el&&el.dispatchEvent(event)},xhr.onload=()=>{if(200==xhr.status)try{let response=JSON.parse(xhr.responseText);if(!response.status)return xhr.onerror();if(response.redirect)return location.href=response.redirect;morphdom(component.el,response.html,{onNodeAdded:node=>{node.hasAttribute("r-id")&&(window.reactables.components.push(new ReactablesComponent(node)),node.skipAddingChildren=!0)},getNodeKey:node=>{let key=node.getAttribute("r-key");return key||node.id},onBeforeElUpdated:(from,to)=>!from.isEqualNode(to)}),component.data=JSON.parse(response.data),component.files={},component.removeAttrs(),component.bind(),component.parseQuery(response.query),component.dispatchEvents(response.events),component.toggleLoads(),component.removeInits();let event=new Event("reactables-update-success");component.el.dispatchEvent(event)}catch(error){console.error(error),xhr.onerror()}else 403==xhr.status?window.reactables.expiredHandler?window.reactables.expiredHandler({status:xhr.status,body:xhr.responseText}):window.reactables.showExpired():xhr.onerror()},xhr.onerror=()=>{window.reactables.errorHandler?window.reactables.errorHandler({status:xhr.status,body:xhr.responseText}):window.reactables.showError(xhr.responseText)},xhr.send(data)}}window.reactables?console.error("[Reactables] You don't neet to included the assets more than once!"):(window.reactables=new Reactables,window.Reactables=window.reactables,window.reactables.init())});